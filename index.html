<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Farm</title>

  <!-- Leaflet (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#e8f5e9; --layer:#c8e6c9; --ink:#1b5e20; --ink-2:#33691e; --accent:#81c784;
      --card:#cfe9cf; --shadow:0 4px 10px rgba(0,0,0,.12);
    }
    [data-theme="dark"]{
      --bg:#0f1a12; --layer:#17341f; --ink:#d7f5dc; --ink-2:#b7e4bf; --accent:#2e7d32;
      --card:#204a2b; --shadow:0 6px 18px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Segoe UI", system-ui, sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column; min-height:100vh;
    }

    .page{flex:1; display:none; padding:18px; animation:fade .35s ease forwards; overflow:auto}
    .page.active{display:block}
    @keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    .header{ text-align:center; margin:6px 0 14px }
    .title{ font-size:22px; margin:0 0 6px; color:var(--ink) }
    .sub{ color:var(--ink-2); margin:0; font-size:14px }

    .menu-grid{ display:grid; gap:14px; grid-template-columns:repeat(3,1fr); }
    .menu-item{
      background:var(--layer); border-radius:16px; padding:18px 10px; text-align:center;
      cursor:pointer; box-shadow:var(--shadow); transition:.25s transform,.25s filter; user-select:none;
    }
    .menu-item:hover{ transform:translateY(-3px); filter:brightness(1.03) }
    .menu-item .emj{font-size:20px}
    .menu-item .lbl{ display:block; margin-top:8px; font-weight:700; color:var(--ink) }

    .card{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px; margin:10px 0; }
    .card h2{margin:0 0 10px; font-size:18px}
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
    label{font-size:13px; color:var(--ink-2)}
    input,select,button,textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid transparent;
      background:#fff; color:#0f0f0f; outline:none;
    }
    [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{
      background:#122118; color:#e8ffe9; border-color:#203a26;
    }
    button{ background:var(--accent); color:#06350d; font-weight:700; cursor:pointer; box-shadow:var(--shadow); }
    .help{font-size:12px; color:var(--ink-2)}

    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px }
    th,td{ padding:10px; text-align:left; }
    thead tr{ background:var(--layer) }
    tbody tr{ background:#fff }
    [data-theme="dark"] tbody tr{ background:#0f1a12 }
    tbody tr+tr td{ border-top:1px solid rgba(0,0,0,.06) }
    [data-theme="dark"] tbody tr+tr td{ border-top:1px solid #203a26 }

    .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .right{ margin-left:auto }

    .bottom-nav{
      position:sticky; bottom:0; left:0; right:0;
      display:grid; grid-template-columns:repeat(4,1fr);
      background:var(--layer); padding:8px 0;
      border-top-left-radius:14px; border-top-right-radius:14px; box-shadow:0 -4px 10px rgba(0,0,0,.1);
    }
    .tab{
      background:none;border:none;color:var(--ink); font-size:13px; display:flex;
      flex-direction:column; align-items:center; gap:4px; padding:6px 0; cursor:pointer; opacity:.9
    }
    .tab.active{ opacity:1; font-weight:700; text-decoration:underline }
    .tab .emj{font-size:18px}

    #farmMap{ height:65vh; border-radius:14px; box-shadow:var(--shadow); }
    .legend{ background:rgba(255,255,255,.92); padding:8px 10px; border-radius:10px; font-size:12px }
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}

    @media (max-width:900px){ .menu-grid{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:560px){ .menu-grid{ grid-template-columns:1fr } .row,.row-3{ grid-template-columns:1fr } }
  </style>
</head>
<body>

  <!-- HOME -->
  <section id="home" class="page active">
    <div class="header">
      <h1 class="title">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã</h1>
      <p class="sub">‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® & ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
    </div>

    <div class="card">
      <h2>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® & ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ</h2>
      <div class="row">
        <div>
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
          <input id="locInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ¬∑ ‡πÄ‡∏°‡∏∑‡∏≠‡∏á" />
          <div class="help">‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
        </div>
        <div class="flex" style="align-items:end">
          <button id="btnFetch" style="min-width:160px">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button id="btnTheme" class="right" title="‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°">‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏°‡∏∑‡∏î</button>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h3 style="margin:0 0 6px">üå§Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
          <div id="weatherBox" class="help">‡∏Å‡∏î ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á (‡πÄ‡∏î‡πÇ‡∏°‡πà)</div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">üçå ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ</h3>
          <div id="priceBox" class="help">‡∏Å‡∏•‡πâ‡∏ß‡∏¢/‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á/‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏î‡πÇ‡∏°‡πà)</div>
        </div>
      </div>
    </div>

    <div class="menu-grid" style="margin-top:14px">
      <div class="menu-item" onclick="showPage('disease')"><span class="emj">üîç</span><span class="lbl">‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ</span></div>
      <div class="menu-item" onclick="showPage('care')"><span class="emj">üå±</span><span class="lbl">‡∏î‡∏π‡πÅ‡∏•</span></div>
      <div class="menu-item" onclick="showPage('work')"><span class="emj">‚öôÔ∏è</span><span class="lbl">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="menu-item" onclick="showPage('water')"><span class="emj">üíß</span><span class="lbl">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏õ‡∏∏‡πã‡∏¢</span></div>
      <div class="menu-item" onclick="showPage('fertilizer')"><span class="emj">üåø</span><span class="lbl">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢</span></div>
      <div class="menu-item" onclick="showPage('report')"><span class="emj">üìä</span><span class="lbl">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    </div>
  </section>

  <!-- DISEASE -->
  <section id="disease" class="page">
    <div class="header"><h1 class="title">üîç ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä</h1><p class="sub">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (‡πÄ‡∏î‡πÇ‡∏°‡πà‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)</p></div>
    <div class="card">
      <div class="row">
        <div>
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</label>
          <input type="file" id="diseaseFile" accept="image/*" />
          <div id="diseasePreview" style="margin-top:12px"></div>
        </div>
        <div>
          <label>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
          <textarea id="diseaseResult" rows="8" placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à..."></textarea>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button id="btnDiseaseDemo">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÄ‡∏î‡πÇ‡∏°‡πà)</button>
        <button id="btnMarkDisease" title="‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏î‡πÇ‡∏°‡πà)</button>
        <span class="help">TODO: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Teachable Machine ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á</span>
      </div>
      <div class="card" style="margin-top:10px">
        <h3 style="margin:0 0 8px">Top-3 (‡πÄ‡∏î‡πÇ‡∏°‡πà)</h3>
        <div id="top3Box" class="help">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- CARE -->
  <section id="care" class="page">
    <div class="header"><h1 class="title">üå± ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏∑‡∏ä</h1></div>
    <div class="card">
      <h2>‡∏ó‡∏¥‡∏õ‡∏™‡πå‡∏ä‡πà‡∏ß‡∏á‡∏ù‡∏ô</h2>
      <ul>
        <li>‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏¥‡∏ô‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤</li>
        <li>‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á‡∏£‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô</li>
        <li>‡∏û‡πà‡∏ô‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏∏‡∏Å 7‚Äì10 ‡∏ß‡∏±‡∏ô</li>
      </ul>
    </div>
  </section>

  <!-- WORK -->
  <section id="work" class="page">
    <div class="header"><h1 class="title">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h1><p class="sub">‡πÇ‡∏ô‡πâ‡∏ï‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°</p></div>
    <div class="card">
      <div class="row">
        <div><label>‡∏á‡∏≤‡∏ô</label><input id="taskName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤"></div>
        <div><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="taskDate" type="date"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label><input id="taskArea" placeholder="‡πÑ‡∏£‡πà/‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà..."></div>
        <div><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="taskNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡∏ö‡∏µ‡∏ó‡∏µ 50 ‡∏Å‡∏£‡∏±‡∏°"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button onclick="addTask()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
        <button class="right" onclick="exportCSV()">Export CSV</button>
      </div>
    </div>
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h2>
      <div class="help">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>
      <table id="taskTable">
        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏á‡∏≤‡∏ô</th><th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- WATER -->
  <section id="water" class="page">
    <div class="header"><h1 class="title">üíß ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏õ‡∏∏‡πã‡∏¢</h1></div>
    <div class="card">
      <div class="row-3">
        <div><label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà)</label><input id="wArea" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.5"></div>
        <div><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ô‡πâ‡∏≥ (‡∏•‡∏¥‡∏ï‡∏£/‡πÑ‡∏£‡πà)</label><input id="wRate" type="number" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 800"></div>
        <div><label>% ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏õ‡∏∏‡πã‡∏¢ (w/v)</label><input id="wPct" type="number" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.5"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button onclick="calcWater()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        <span id="wOut" class="help"></span>
      </div>
    </div>
  </section>

  <!-- FERTILIZER -->
  <section id="fertilizer" class="page">
    <div class="header"><h1 class="title">üåø ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢</h1><p class="sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p></div>
    <div class="card">
      <div class="row">
        <div>
          <label>‡∏û‡∏∑‡∏ä</label>
          <select id="fzPlant">
            <option value="banana">‡∏Å‡∏•‡πâ‡∏ß‡∏¢</option>
            <option value="mango">‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á</option>
            <option value="durian">‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <option value="rice">‡∏Ç‡πâ‡∏≤‡∏ß</option>
            <option value="vegetable">‡∏ú‡∏±‡∏Å‡πÉ‡∏ö</option>
          </select>
        </div>
        <div style="align-self:end"><button onclick="showFormula()">‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£</button></div>
      </div>
      <div id="fzBox" class="card" style="margin-top:10px">
        <div class="help">‡∏à‡∏∞‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏û‡∏∑‡∏ä/‡∏£‡∏∞‡∏¢‡∏∞‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</div>
      </div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="report" class="page">
    <div class="header"><h1 class="title">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1><p class="sub">‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô + ‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ)</p></div>
    <div class="card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏î‡πÇ‡∏°‡πà)</h2>
      <div id="reportBox" class="help">TODO: ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢ canvas/Chart.js ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chat" class="page">
    <div class="header"><h1 class="title">ü§ñ ‡πÅ‡∏ä‡∏ó AI</h1><p class="sub">‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ß‡∏≤‡∏á UI ‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ</p></div>
    <div class="card">
      <div class="row">
        <input id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°..." />
        <button onclick="demoChat()">‡∏™‡πà‡∏á</button>
      </div>
      <div id="chatBox" class="card" style="margin-top:10px; min-height:80px"></div>
    </div>
  </section>

  <!-- LOCATION (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) -->
  <section id="location" class="page">
    <div class="header">
      <h1 class="title">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</h1>
      <p class="sub">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° + ‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ</p>
    </div>

    <div class="card">
      <div class="flex">
        <button onclick="loc_readGPS()">‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <button onclick="loc_setClickColor('green')">‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        <button onclick="loc_setClickColor('yellow')">‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î</button>
        <button onclick="loc_setClickColor('red')">‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏î‡∏á: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏î</button>
        <button class="right" onclick="loc_clear()">‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div class="flex" style="margin-top:8px">
        <button onclick="loc_calibrate()">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <button onclick="loc_clearCal()">‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>

      <div id="farmMap" style="margin-top:10px"></div>
      <div class="help" style="margin-top:8px">
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ¬∑ ‚Äú‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ (‡∏°‡πà‡∏ß‡∏á)‚Äù ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏≤‡∏Å GPS ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)
      </div>
    </div>
  </section>

  <!-- ACCOUNT -->
  <section id="account" class="page">
    <div class="header"><h1 class="title">üë§ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1></div>
    <div class="card">
      <div class="row">
        <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≤‡∏£‡πå‡∏°</label><input id="accFarm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡∏ô‡∏ã‡∏±‡∏ô"></div>
        <div><label>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label><input id="accOwner" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏±‡∏ô"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button onclick="saveAccount()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <span id="accMsg" class="help"></span>
      </div>
    </div>
  </section>

  <nav class="bottom-nav">
    <button class="tab active" data-tab="home" onclick="showPage('home')"><span class="emj">üè†</span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button class="tab" data-tab="chat" onclick="showPage('chat')"><span class="emj">ü§ñ</span>‡πÅ‡∏ä‡∏ó AI</button>
    <button class="tab" data-tab="location" onclick="showPage('location')"><span class="emj">üìç</span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
    <button class="tab" data-tab="account" onclick="showPage('account')"><span class="emj">üë§</span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
  </nav>

  <script>
/* ===================== MAP + GPS (‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô TDZ) ===================== */
let map, baseLayer, clickColor='green';
const layerWork = L.layerGroup();
const layerDisease = L.layerGroup();
const LS_WORK = 'sf_map_work_v1';
const LS_DISEASE = 'sf_map_disease_v1';
let pendingDisease = null;
let accCircle = null;   // ‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
let lastRawPos = null;  // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡∏¥‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï

function colorIcon(color){
  const html = `<div style="position:relative;width:20px;height:20px;background:${color};border-radius:50%;
    border:2px solid #fff;box-shadow:0 0 6px rgba(0,0,0,.4);"></div>`;
  return L.divIcon({className:'', html, iconSize:[20,20], iconAnchor:[10,10]});
}
function diseaseIcon(){
  const html = `<div style="position:relative;width:22px;height:22px;background:#a97cff;border-radius:50%;
    border:2px solid #fff;box-shadow:0 0 8px rgba(0,0,0,.5);"></div>`;
  return L.divIcon({className:'', html, iconSize:[22,22], iconAnchor:[11,11]});
}
const ICONS = {
  green:  colorIcon('#39d353'),
  yellow: colorIcon('#ffd33d'),
  red:    colorIcon('#ff4d4f'),
  disease: diseaseIcon(),
  user: L.icon({
    iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize:[25,41],iconAnchor:[12,41],shadowSize:[41,41]
  })
};

function initMap(){
  baseLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: '&copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community' }
  );
  map = L.map('farmMap', { center:[13.736,100.523], zoom:15, layers:[baseLayer, layerWork, layerDisease] });

  // Legend
  const legend = L.control({position:'topright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <div><span class="dot" style="background:#39d353"></span> ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
      <div><span class="dot" style="background:#ffd33d"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î</div>
      <div><span class="dot" style="background:#ff4d4f"></span> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏î</div>
      <hr style="border:none;border-top:1px solid #ddd;margin:6px 0">
      <div><span class="dot" style="background:#a97cff"></span> ‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ</div>`;
    return div;
  }; legend.addTo(map);

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  map.on('click', (e)=>{
    if(pendingDisease){
      placeDiseaseMarker(e.latlng.lat, e.latlng.lng, pendingDisease.cls, pendingDisease.prob);
      pendingDisease = null; return;
    }
    placeWorkMarker(e.latlng.lat, e.latlng.lng, clickColor);
    saveWorkMarkers();
  });

  loadWorkMarkers();
  loadDiseaseMarkers();
}

function loc_setClickColor(c){
  clickColor = c;
  if(map){
    L.popup().setLatLng(map.getCenter()).setContent('‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏°‡∏∏‡∏î: '+(c==='green'?'‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß':c==='yellow'?'‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á':'‡πÅ‡∏î‡∏á')).openOn(map);
  }
}
function loc_clear(){
  const toRemove = [];
  layerWork.eachLayer(l=>{
    if(l !== window._userMarker && l !== accCircle) toRemove.push(l);
  });
  toRemove.forEach(l=>layerWork.removeLayer(l));
  localStorage.removeItem(LS_WORK);
}

// ‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï
function readOffset(){ try{ return JSON.parse(localStorage.getItem('sf_gps_offset')||'null'); }catch{ return null } }
function saveOffset(dlat, dlng){ localStorage.setItem('sf_gps_offset', JSON.stringify({dlat, dlng})); }
function clearOffset(){ localStorage.removeItem('sf_gps_offset'); }

// ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô (Browser precise ‚Üí coarse ‚Üí IP API ‚Üí (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô) Google)
function getAccuratePosition({desired=25, timeout=15000}={}){
  return new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error('no geolocation'));
    let best=null; const start=Date.now();
    const id = navigator.geolocation.watchPosition(
      pos=>{
        best = (!best || pos.coords.accuracy < best.coords.accuracy) ? pos : best;
        if(pos.coords.accuracy <= desired){ navigator.geolocation.clearWatch(id); resolve(best); }
        else if(Date.now()-start>timeout){ navigator.geolocation.clearWatch(id); resolve(best||pos); }
      },
      err=>{ navigator.geolocation.clearWatch(id); reject(err); },
      { enableHighAccuracy:true, maximumAge:0, timeout }
    );
  });
}
const getCoarse = ({timeout=12000}={}) =>
  new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error('no geolocation'));
    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:false, maximumAge:60000, timeout });
  });
async function ipGeo(){
  const r = await fetch('https://ipapi.co/json/');
  if(!r.ok) throw new Error('ipapi fail');
  const j = await r.json();
  if(j.latitude==null || j.longitude==null) throw new Error('ipapi no lat/lng');
  return { lat:Number(j.latitude), lng:Number(j.longitude), acc:10000, source:'ipapi' };
}
async function googleGeo(apiKey){
  const r = await fetch(`https://www.googleapis.com/geolocation/v1/geolocate?key=${apiKey}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ considerIp: true })
  });
  if(!r.ok) throw new Error('google geo fail');
  const j = await r.json();
  return { lat:j.location.lat, lng:j.location.lng, acc:j.accuracy||100, source:'google' };
}
async function getSmartPosition({useGoogle=false, googleKey=''}={}){
  try{
    const p = await getAccuratePosition({desired:25, timeout:15000});
    return { lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy, source:'browser' };
  }catch{
    try{
      const p = await getCoarse({timeout:12000});
      return { lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy, source:'browser-coarse' };
    }catch{
      try{ return await ipGeo(); }
      catch{
        if(useGoogle && googleKey) return await googleGeo(googleKey);
        throw new Error('no position available');
      }
    }
  }
}
async function loc_readGPS(){
  try{
    const pos = await getSmartPosition({ /*useGoogle:true, googleKey:'YOUR_API_KEY'*/ });
    lastRawPos = { lat: pos.lat, lng: pos.lng, acc: pos.acc };

    const off = readOffset();
    const lat = lastRawPos.lat + (off?.dlat || 0);
    const lng = lastRawPos.lng + (off?.dlng || 0);

    if(!map) initMap();

    if(accCircle){ layerWork.removeLayer(accCircle); accCircle=null; }
    accCircle = L.circle([lat, lng], { radius: Math.max(lastRawPos.acc, 8), color:'#3388ff', fillOpacity:0.1 }).addTo(layerWork);

    if(window._userMarker){ layerWork.removeLayer(window._userMarker); }
    window._userMarker = L.marker([lat, lng], {icon:ICONS.user})
      .bindPopup(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô<br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><small>accuracy ~ ${Math.round(lastRawPos.acc)} m ‚Ä¢ source: ${pos.source}</small>`)
      .addTo(layerWork).openPopup();

    map.setView([lat, lng], lastRawPos.acc > 8000 ? 13 : lastRawPos.acc > 80 ? 16 : 17);
  }catch(err){
    alert('‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message +
      '\n‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô http://localhost ‡∏´‡∏£‡∏∑‡∏≠ HTTPS\n‚Ä¢ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Location ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
  }
}
function loc_calibrate(){
  if(!map){ showPage('location'); initMap(); }
  if(!lastRawPos){ alert('‡∏Å‡∏î "‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö'); return; }
  const tip = L.popup().setLatLng(map.getCenter()).setContent('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á').openOn(map);
  const once = (e)=>{
    map.off('click', once); map.closePopup(tip);
    const t = e.latlng;
    saveOffset(t.lat-lastRawPos.lat, t.lng-lastRawPos.lng);
    if(window._userMarker){ layerWork.removeLayer(window._userMarker); }
    window._userMarker = L.marker([t.lat, t.lng], {icon:ICONS.user})
      .bindPopup(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)<br>${t.lat.toFixed(6)}, ${t.lng.toFixed(6)}`).addTo(layerWork).openPopup();
    if(accCircle){ layerWork.removeLayer(accCircle); }
    accCircle = L.circle([t.lat, t.lng], { radius: Math.max(lastRawPos.acc, 8), color:'#3388ff', fillOpacity:0.1 }).addTo(layerWork);
  };
  map.on('click', once);
}
function loc_clearCal(){ clearOffset(); alert('‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'); loc_readGPS(); }

// ‡∏´‡∏°‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡πÇ‡∏£‡∏Ñ + persist
function placeWorkMarker(lat,lng,color='green'){
  const mk = L.marker([lat,lng], {icon:ICONS[color]}).addTo(layerWork);
  mk.bindPopup(`‡∏á‡∏≤‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥: <b>${color}</b><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><button onclick="loc_deleteWork(${lat},${lng})">‡∏•‡∏ö</button>`);
}
function loc_deleteWork(lat,lng){
  layerWork.eachLayer(layer=>{
    const p = layer.getLatLng?.(); if(p && p.lat.toFixed(6)==lat.toFixed(6) && p.lng.toFixed(6)==lng.toFixed(6)){
      layerWork.removeLayer(layer); saveWorkMarkers();
    }
  });
}
function saveWorkMarkers(){
  const arr = [];
  layerWork.eachLayer(layer=>{
    if(layer===window._userMarker || layer===accCircle) return;
    const p = layer.getLatLng?.(); if(!p) return;
    const html = layer.options.icon?.options?.html || '';
    const color = html.includes('#ff4d4f') ? 'red' : html.includes('#ffd33d') ? 'yellow' : 'green';
    arr.push({lat:p.lat,lng:p.lng,color});
  });
  localStorage.setItem(LS_WORK, JSON.stringify(arr));
}
function loadWorkMarkers(){
  try{ (JSON.parse(localStorage.getItem(LS_WORK)||'[]')||[]).forEach(m=>placeWorkMarker(m.lat,m.lng,m.color)); }catch{}
}
function placeDiseaseMarker(lat,lng,cls,prob){
  const mk = L.marker([lat,lng], {icon:ICONS.disease}).addTo(layerDisease);
  const ts = new Date().toLocaleString();
  mk.bindPopup(`‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ: <b>${cls}</b><br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${(prob*100).toFixed(1)}%<br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><i>${ts}</i>
    <br><button onclick="loc_deleteDisease(${lat},${lng})">‡∏•‡∏ö</button>`).openPopup();
  saveDiseaseMarkers();
}
function loc_deleteDisease(lat,lng){
  layerDisease.eachLayer(layer=>{
    const p = layer.getLatLng?.(); if(p && p.lat.toFixed(6)==lat.toFixed(6) && p.lng.toFixed(6)==lng.toFixed(6)){
      layerDisease.removeLayer(layer); saveDiseaseMarkers();
    }
  });
}
function saveDiseaseMarkers(){
  const arr = [];
  layerDisease.eachLayer(layer=>{
    const p = layer.getLatLng?.(); if(!p) return;
    const meta = layer.getPopup()?.getContent() || '';
    const m = /‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ:\s*<b>(.*?)<\/b>.*?(\d+(?:\.\d+)?)%/s.exec(meta);
    arr.push({lat:p.lat,lng:p.lng,cls:m?m[1]:'Unknown',prob:m?Number(m[2])/100:0});
  });
  localStorage.setItem(LS_DISEASE, JSON.stringify(arr));
}
function loadDiseaseMarkers(){
  try{ (JSON.parse(localStorage.getItem(LS_DISEASE)||'[]')||[]).forEach(m=>placeDiseaseMarker(m.lat,m.lng,m.cls,m.prob)); }catch{}
}
async function diseaseToMap(cls, prob){
  if(!map){ showPage('location'); initMap(); }
  try{
    const p = await getSmartPosition();
    placeDiseaseMarker(p.lat, p.lng, cls, prob);
    map.setView([p.lat,p.lng], 18);
  }catch{
    pendingDisease = {cls, prob};
    showPage('location');
    L.popup().setLatLng(map.getCenter()).setContent('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á ‚Äú‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ‚Äù').openOn(map);
  }
}
window.diseaseToMap = diseaseToMap;
/* ===================== /MAP + GPS ===================== */

    // -------- Router --------
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
      localStorage.setItem('sf_last', id);
      if(id==='location' && !map){ initMap(); }
    }

    (function init(){
      const last = localStorage.getItem('sf_last'); if(last && document.getElementById(last)) showPage(last);
      const theme = localStorage.getItem('sf_theme') || 'light'; document.documentElement.dataset.theme = theme;
      const farm = localStorage.getItem('sf_farm')||''; const owner = localStorage.getItem('sf_owner')||'';
      document.getElementById('accFarm').value = farm; document.getElementById('accOwner').value = owner;
      document.getElementById('locInput').value = localStorage.getItem('sf_loc')||'';
      renderTasks();
      demoFillHome();
      if(document.getElementById('location').classList.contains('active')) initMap();
    })();

    document.getElementById('btnTheme')?.addEventListener('click', ()=>{
      const cur = document.documentElement.dataset.theme==='dark'?'light':'dark';
      document.documentElement.dataset.theme = cur;
      localStorage.setItem('sf_theme', cur);
    });

    document.getElementById('btnFetch')?.addEventListener('click', demoFillHome);
    function demoFillHome(){
      const loc = document.getElementById('locInput').value.trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ¬∑ ‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á';
      localStorage.setItem('sf_loc', loc);
      const w = { temp: 31, humid: 72, cond:'‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', rain: 35 };
      document.getElementById('weatherBox').innerHTML =
        `<div><b>${loc}</b></div>
         <div>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ${w.temp}¬∞C ¬∑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ${w.humid}%</div>
         <div>‡∏™‡∏†‡∏≤‡∏û: ${w.cond} ¬∑ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô ${w.rain}%</div>
         <div class="help">TODO: ‡∏ï‡πà‡∏≠ API ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á</div>`;
      const prices = [
        {name:'‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°', unit:'‡∏Å‡∏Å.', price:27},
        {name:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ', unit:'‡∏Å‡∏Å.', price:45},
        {name:'‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á', unit:'‡∏Å‡∏Å.', price:155},
      ];
      document.getElementById('priceBox').innerHTML =
        prices.map(p=>`‚Ä¢ ${p.name} ~ <b>${p.price}</b> ‡∏ö‡∏≤‡∏ó/${p.unit}`).join('<br>')+
        `<div class="help">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</div>`;
    }

    // -------- Disease demo --------
    document.getElementById('diseaseFile')?.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      document.getElementById('diseasePreview').innerHTML =
        `<img src="${url}" style="max-width:100%; border-radius:12px">`;
    });
    document.getElementById('btnDiseaseDemo')?.addEventListener('click', ()=>{
      const txt = "‡πÄ‡∏î‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πÇ‡∏°‡πà: ‡πÉ‡∏ö‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏®‡∏©‡πÉ‡∏ö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏û‡πà‡∏ô‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£";
      document.getElementById('diseaseResult').value = txt;
      document.getElementById('top3Box').innerHTML = "‚Ä¢ A1 ‚Äî 76.2%<br>‚Ä¢ Healthy ‚Äî 18.9%<br>‚Ä¢ A2 ‚Äî 4.9%";
    });

    // -------- Tasks --------
    function readTasks(){ try{ return JSON.parse(localStorage.getItem('sf_tasks')||'[]'); }catch{ return [] } }
    function writeTasks(list){ localStorage.setItem('sf_tasks', JSON.stringify(list)); }
    function addTask(){
      const name = document.getElementById('taskName').value.trim();
      const date = document.getElementById('taskDate').value || new Date().toISOString().slice(0,10);
      const area = document.getElementById('taskArea').value.trim();
      const note = document.getElementById('taskNote').value.trim();
      if(!name){ alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); return }
      const items = readTasks(); items.unshift({date,name,area,note}); writeTasks(items); renderTasks();
      document.getElementById('taskName').value=''; document.getElementById('taskNote').value='';
    }
    function delTask(idx){ const items = readTasks(); items.splice(idx,1); writeTasks(items); renderTasks(); }
    function renderTasks(){
      const tb = document.querySelector('#taskTable tbody'); tb.innerHTML='';
      readTasks().forEach((t,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.date}</td><td>${t.name}</td><td>${t.area||'-'}</td><td>${t.note||'-'}</td>
                        <td><button onclick="delTask(${i})">‡∏•‡∏ö</button></td>`;
        tb.appendChild(tr);
      });
    }
    function exportCSV(){
      const rows = [['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏á‡∏≤‡∏ô','‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], ...readTasks().map(t=>[t.date,t.name,t.area||'',t.note||''])];
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      const a = Object.assign(document.createElement('a'), {href:url, download:'smartfarm-tasks.csv'}); a.click();
      URL.revokeObjectURL(url);
    }

    // -------- ‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Disease --------
    window.diseaseToMap = diseaseToMap;

    // -------- Account helpers --------
    function saveAccount(){
      localStorage.setItem('sf_farm', document.getElementById('accFarm').value.trim());
      localStorage.setItem('sf_owner', document.getElementById('accOwner').value.trim());
      document.getElementById('accMsg').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      setTimeout(()=>document.getElementById('accMsg').textContent='', 2000);
    }

    /* ======= ‡πÅ‡∏ä‡∏ó: ‡∏ï‡πà‡∏≠ Gemini ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÇ‡∏ú‡∏•‡πà) ======= */
    const GEMINI_API_KEY = 'AIzaSyBCbwvS7PGXQZYxn2xLJ-VJMRMSaNItRFE'; // <<<< ‡∏°‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏≤
    const GEMINI_MODEL  = 'gemini-1.5-flash';
    const GEMINI_URL    = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;

    function extractText(resp) {
      try {
        const c = resp.candidates?.[0]?.content?.parts?.[0]?.text;
        return c || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)';
      } catch { return '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)'; }
    }

async function demoChat(){
  const box = document.getElementById('chatBox');
  const q = document.getElementById('chatInput').value.trim();
  if(!q) return;

  const you = document.createElement('div');
  you.innerHTML = `<b>‡∏Ñ‡∏∏‡∏ì:</b> ${q}`;
  box.appendChild(you);

  try {
    const r = await fetch(GEMINI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ role: 'user', parts: [{ text: q }]}]
      })
    });

    if (!r.ok) {
      let msg = r.status + ' ' + r.statusText;
      try { const j = await r.json(); msg = j.error?.message || msg; } catch {}
      throw new Error(msg);
    }
    const data = await r.json();
    const reply = extractText(data);

    const bot = document.createElement('div');
    bot.innerHTML = `<b>‡∏ö‡∏≠‡∏ó:</b> ${reply}`;
    box.appendChild(bot);
  } catch (e) {
    const err = document.createElement('div');
    err.style.color = 'crimson';
    err.innerHTML = `<b>‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> ${e.message || 'Failed to fetch'}`;
    box.appendChild(err);
    console.error(e);
  }

  document.getElementById('chatInput').value='';
}
    /* ======= /‡πÅ‡∏ä‡∏ó ======= */
  </script>
</body>
</html>
