<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Farm</title>

  <!-- Leaflet (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#e8f5e9; --layer:#c8e6c9; --ink:#1b5e20; --ink-2:#33691e; --accent:#81c784;
      --card:#cfe9cf; --shadow:0 4px 10px rgba(0,0,0,.12);
    }
    [data-theme="dark"]{
      --bg:#0f1a12; --layer:#17341f; --ink:#d7f5dc; --ink-2:#b7e4bf; --accent:#2e7d32;
      --card:#204a2b; --shadow:0 6px 18px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Segoe UI", system-ui, sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column; min-height:100vh;
    }

    .page{flex:1; display:none; padding:18px; animation:fade .35s ease forwards; overflow:auto}
    .page.active{display:block}
    @keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    .header{ text-align:center; margin:6px 0 14px }
    .title{ font-size:22px; margin:0 0 6px; color:var(--ink) }
    .sub{ color:var(--ink-2); margin:0; font-size:14px }

    .menu-grid{ display:grid; gap:14px; grid-template-columns:repeat(3,1fr); }
    .menu-item{
      background:var(--layer); border-radius:16px; padding:18px 10px; text-align:center;
      cursor:pointer; box-shadow:var(--shadow); transition:.25s transform,.25s filter; user-select:none;
    }
    .menu-item:hover{ transform:translateY(-3px); filter:brightness(1.03) }
    .menu-item .emj{font-size:20px}
    .menu-item .lbl{ display:block; margin-top:8px; font-weight:700; color:var(--ink) }

    .card{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px; margin:10px 0; }
    .card h2{margin:0 0 10px; font-size:18px}
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
    label{font-size:13px; color:var(--ink-2)}
    input,select,button,textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid transparent;
      background:#fff; color:#0f0f0f; outline:none;
    }
    [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{
      background:#122118; color:#e8ffe9; border-color:#203a26;
    }
    button{ background:var(--accent); color:#06350d; font-weight:700; cursor:pointer; box-shadow:var(--shadow); }
    .help{font-size:12px; color:var(--ink-2)}

    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px }
    th,td{ padding:10px; text-align:left; }
    thead tr{ background:var(--layer) }
    tbody tr{ background:#fff }
    [data-theme="dark"] tbody tr{ background:#0f1a12 }
    tbody tr+tr td{ border-top:1px solid rgba(0,0,0,.06) }
    [data-theme="dark"] tbody tr+tr td{ border-top:1px solid #203a26 }

    .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .right{ margin-left:auto }

    .bottom-nav{
      position:sticky; bottom:0; left:0; right:0;
      display:grid; grid-template-columns:repeat(4,1fr);
      background:var(--layer); padding:8px 0;
      border-top-left-radius:14px; border-top-right-radius:14px; box-shadow:0 -4px 10px rgba(0,0,0,.1);
    }
    .tab{
      background:none;border:none;color:var(--ink); font-size:13px; display:flex;
      flex-direction:column; align-items:center; gap:4px; padding:6px 0; cursor:pointer; opacity:.9
    }
    .tab.active{ opacity:1; font-weight:700; text-decoration:underline }
    .tab .emj{font-size:18px}

    #farmMap{ height:65vh; border-radius:14px; box-shadow:var(--shadow); }
    .legend{ background:rgba(255,255,255,.92); padding:8px 10px; border-radius:10px; font-size:12px }
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}

    @media (max-width:900px){ .menu-grid{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:560px){ .menu-grid{ grid-template-columns:1fr } .row,.row-3{ grid-template-columns:1fr } }

    /* ==== Video gallery ==== */
    .video-grid{display:grid;gap:14px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.video-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.video-grid{grid-template-columns:1fr}}

    .video-card{
      background:var(--layer); border-radius:16px; box-shadow:var(--shadow);
      overflow:hidden; transition:transform .2s ease, filter .2s ease; cursor:pointer
    }
    .video-card:hover{transform:translateY(-2px); filter:brightness(1.03)}
    .thumb-wrap{position:relative; width:100%; padding-top:56.25%; background:#000}
    .thumb-wrap img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .video-info{padding:10px 12px}
    .video-title{font-weight:700; font-size:14px; color:var(--ink)}
    .video-meta{font-size:12px; color:var(--ink-2); margin-top:4px}

    /* Modal (‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á video/guide/order) */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999}
    .modal.show{display:flex}
    .modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.65)}
    .modal-content{
      position:relative; width:min(960px,92vw); background:var(--card); border-radius:14px;
      box-shadow:var(--shadow); padding:12px
    }
    .modal-close{
      position:absolute; top:6px; right:8px; border:none; background:transparent;
      font-size:22px; cursor:pointer; color:var(--ink)
    }
    .ratio{position:relative; width:100%; padding-top:56.25%; background:#000; border-radius:10px; overflow:hidden}
    .ratio iframe{position:absolute; inset:0; width:100%; height:100%; border:0}
    .modal-title{margin:8px 4px 0; font-size:14px; color:var(--ink-2)}

    /* ==== WORK sensors ==== */
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:700px){.grid-3,.grid-2{grid-template-columns:1fr}}
    .sensor{background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    [data-theme="dark"] .sensor{background:#122118;color:#e8ffe9;border:1px solid #203a26}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#c8e6c9;color:#1b5e20}
    .warn{background:#fff3cd;color:#7c5a00}
    .err{background:#ffebee;color:#b71c1c}
    .led{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px}

    /* ==== WATER (3 ‡∏ñ‡∏±‡∏á) ==== */
    .tank-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.tank-grid{grid-template-columns:1fr}}
    .tank{background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    [data-theme="dark"] .tank{background:#122118;color:#e8ffe9;border:1px solid #203a26}
    .bar{height:10px;background:#e0e0e0;border-radius:999px;overflow:hidden}
    .bar>div{height:100%;width:0%}
    .tip{font-size:12px;color:#555}
    [data-theme="dark"] .tip{color:#b7e4bf}

    /* ==== Fertilizer shop ==== */
    .shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.shop-grid{grid-template-columns:1fr}}
    .product{background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column}
    [data-theme="dark"] .product{background:#122118;color:#e8ffe9;border:1px solid #203a26}
    .p-img{width:100%;aspect-ratio:4/3;border-radius:10px;object-fit:cover;background:linear-gradient(135deg,#9be7a0,#c8e6c9)}
    .p-title{font-weight:700;margin:10px 0 4px}
    .p-desc{font-size:13px;color:var(--ink-2)}
    .p-actions{margin-top:auto;display:flex;gap:8px;align-items:center}

    /* === Account page extras === */
    .profile-card{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .avatar-wrap{width:110px;height:110px;border-radius:50%;overflow:hidden;box-shadow:var(--shadow);background:#fff;display:flex;align-items:center;justify-content:center}
    .avatar-wrap img{width:100%;height:100%;object-fit:cover}
    .avatar-actions{display:flex;flex-direction:column;gap:8px}
    .small{font-size:12px;color:var(--ink-2)}
    .guide-list{margin:8px 0 0 18px}
    .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .stat-box{background:#fff;color:#0f0f0f;border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    [data-theme="dark"] .stat-box{background:#122118;color:#e8ffe9;border:1px solid #203a26}
    .stat-box b{font-size:18px;display:block;margin-top:4px}
  </style>
</head>
<body>

  <!-- HOME -->
  <section id="home" class="page active">
    <div class="header">
      <h1 class="title">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã</h1>
      <p class="sub">‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® & ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ¬∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
    </div>

    <div class="card">
      <h2>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® & ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ</h2>
      <div class="row">
        <div>
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
          <input id="locInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ¬∑ ‡πÄ‡∏°‡∏∑‡∏≠‡∏á" />
          <div class="help">‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
        </div>
        <div class="flex" style="align-items:end">
          <button id="btnFetch" style="min-width:160px">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button id="btnTheme" class="right" title="‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°">‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏°‡∏∑‡∏î</button>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h3 style="margin:0 0 6px">üå§Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
          <div id="weatherBox" class="help">‡∏Å‡∏î ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">üçå ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ</h3>
          <div id="priceBox" class="help">‡∏Å‡∏•‡πâ‡∏ß‡∏¢/‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á/‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>
      </div>
    </div>

    <div class="menu-grid" style="margin-top:14px">
      <div class="menu-item" data-nav="disease"><span class="emj">üîç</span><span class="lbl">‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ</span></div>
      <div class="menu-item" data-nav="care"><span class="emj">üå±</span><span class="lbl">‡∏î‡∏π‡πÅ‡∏•</span></div>
      <div class="menu-item" data-nav="work"><span class="emj">‚öôÔ∏è</span><span class="lbl">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="menu-item" data-nav="water"><span class="emj">üíß</span><span class="lbl">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏õ‡∏∏‡πã‡∏¢</span></div>
      <div class="menu-item" data-nav="fertilizer"><span class="emj">üåø</span><span class="lbl">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢</span></div>
      <div class="menu-item" data-nav="report"><span class="emj">üìä</span><span class="lbl">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    </div>
  </section>

  <!-- DISEASE -->
  <section id="disease" class="page">
    <div class="header"><h1 class="title">üîç ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä</h1><p class="sub">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p></div>
    <div class="card">
      <div class="row">
        <div>
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</label>
          <input type="file" id="diseaseFile" accept="image/*" />
          <div id="diseasePreview" style="margin-top:12px"></div>
        </div>
        <div>
          <label>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
          <textarea id="diseaseResult" rows="8" placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à..."></textarea>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button id="btnDiseaseDemo">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå </button>
        <button id="btnMarkDisease" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ </button>
        <span class="help">TODO: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Teachable Machine ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á</span>
      </div>
      <div class="card" style="margin-top:10px">
        <h3 style="margin:0 0 8px">Top-3 </h3>
        <div id="top3Box" class="help">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- CARE (‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠) -->
  <section id="care" class="page">
    <div class="header">
      <h1 class="title">üå± ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏∑‡∏ä (‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</h1>
      <p class="sub">‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ¬∑ ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    </div>
    <div class="card">
      <div id="videoGrid" class="video-grid"></div>
    </div>
  </section>

  <!-- WORK (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á) -->
  <section id="work" class="page">
    <div class="header"><h1 class="title">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h1><p class="sub">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≥‡∏•‡∏≠‡∏á ‚Äî ‡∏≠‡∏±‡∏•‡∏ï‡∏£‡∏≤‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å x3 ¬∑ ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ¬∑ ‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ù‡∏ô</p></div>
    <div class="card">
      <div class="flex">
        <button id="btnSimStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á</button>
        <button id="btnSimStop">‡∏´‡∏¢‡∏∏‡∏î</button>
        <span class="help">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å ~3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
      </div>
      <div class="grid-3" style="margin-top:10px">
        <div class="sensor">
          <div><span class="badge ok"><span class="led" id="led_us1"></span>‡∏≠‡∏±‡∏•‡∏ï‡∏£‡∏≤‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å #1</span></div>
          <div id="us1_txt" class="help" style="margin-top:8px">‚Äî</div>
        </div>
        <div class="sensor">
          <div><span class="badge ok"><span class="led" id="led_us2"></span>‡∏≠‡∏±‡∏•‡∏ï‡∏£‡∏≤‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å #2</span></div>
          <div id="us2_txt" class="help" style="margin-top:8px">‚Äî</div>
        </div>
        <div class="sensor">
          <div><span class="badge ok"><span class="led" id="led_us3"></span>‡∏≠‡∏±‡∏•‡∏ï‡∏£‡∏≤‡πÇ‡∏ã‡∏ô‡∏¥‡∏Å #3</span></div>
          <div id="us3_txt" class="help" style="margin-top:8px">‚Äî</div>
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="sensor">
          <div><span class="badge ok"><span class="led" id="led_hum"></span>‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</span></div>
          <div id="hum_txt" class="help" style="margin-top:8px">‚Äî</div>
        </div>
        <div class="sensor">
          <div><span class="badge ok"><span class="led" id="led_rain"></span>‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ù‡∏ô</span></div>
          <div id="rain_txt" class="help" style="margin-top:8px">‚Äî</div>
        </div>
      </div>
    </div>
  </section>

  <!-- WATER (3 ‡∏ñ‡∏±‡∏á / ‡∏´‡∏ô‡πà‡∏ß‡∏¢ cm¬≥) -->
  <section id="water" class="page">
    <div class="header"><h1 class="title">üíß ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏õ‡∏∏‡πã‡∏¢ (3 ‡∏ñ‡∏±‡∏á)</h1><p class="sub">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£ (cm¬≥) ¬∑ ‡∏ñ‡∏±‡∏á‡∏•‡∏∞ 20 ‡∏•‡∏¥‡∏ï‡∏£ (20,000 cm¬≥) ¬∑ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ &lt; 5 ‡∏•‡∏¥‡∏ï‡∏£</p></div>
    <div class="card">
      <div class="flex">
        <button id="btnWaterRand">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
        <span class="help">* ‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö UI</span>
      </div>
      <div id="tankGrid" class="tank-grid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- FERTILIZER (‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢ + ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠) -->
  <section id="fertilizer" class="page">
    <div class="header"><h1 class="title">üåø ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢</h1><p class="sub">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p></div>
    <div class="card">
      <div id="shopGrid" class="shop-grid"></div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="report" class="page">
    <div class="header"><h1 class="title">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1><p class="sub">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢ & ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</p></div>
    <div class="card">
      <div class="flex">
        <button id="btnReportRefresh">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        <span class="help">‡∏Å‡∏£‡∏≤‡∏ü</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:10px">
        <div class="card">
          <h3 style="margin:0 0 8px">‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏Å‡∏Å.) ‚Äî ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏Å‡∏Å.</h3>
          <canvas id="fertChart" height="200"></canvas>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•‡πÑ‡∏°‡πâ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</h3>
          <canvas id="priceChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chat" class="page">
    <div class="header"><h1 class="title">ü§ñ ‡πÅ‡∏ä‡∏ó AI</h1><p class="sub"></p></div>
    <div class="card">
      <div class="row">
        <input id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°..." />
        <button id="btnChatSend">‡∏™‡πà‡∏á</button>
      </div>
      <div id="chatBox" class="card" style="margin-top:10px; min-height:100px"></div>
    </div>
  </section>

  <!-- LOCATION (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) -->
  <section id="location" class="page">
    <div class="header">
      <h1 class="title">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</h1>
      <p class="sub">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° + ‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ</p>
    </div>

    <div class="card">
      <div class="flex">
        <button id="btnReadGPS">‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <button id="btnPinGreen">‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        <button id="btnPinYellow">‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î</button>
        <button id="btnPinRed">‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏î‡∏á: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏î</button>
        <button id="btnClearPins" class="right">‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>

      <div class="flex" style="margin-top:8px">
        <button id="btnCalibrate">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <button id="btnClearCal">‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï</button>
        <button id="btnGoFarm">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏≤‡∏£‡πå‡∏° üè°</button>
      </div>

      <div id="farmMap" style="margin-top:10px"></div>
      <div class="help" style="margin-top:8px">
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ¬∑ ‚Äú‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏Ñ (‡∏°‡πà‡∏ß‡∏á)‚Äù ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏≤‡∏Å GPS ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)
      </div>
    </div>
  </section>

  <!-- ACCOUNT -->
  <section id="account" class="page">
    <div class="header"><h1 class="title">üë§ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1><p class="sub">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ¬∑ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ¬∑ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢/‡∏ô‡πâ‡∏≥ (‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ)</p></div>

    <div class="card">
      <h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
      <div class="profile-card">
        <div class="avatar-wrap">
          <img id="accAvatarPreview" alt="avatar" src="" />
        </div>
        <div class="avatar-actions" style="min-width:260px">
          <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
          <input type="file" id="accAvatarFile" accept="image/*" />
          <div class="small">* ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ (localStorage)</div>
        </div>
        <div style="flex:1;min-width:240px">
          <div class="row" style="grid-template-columns:1fr">
            <div><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ</label><input id="accOwner" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏±‡∏ô"></div>
          </div>
          <div class="row" style="margin-top:8px;grid-template-columns:1fr">
            <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≤‡∏£‡πå‡∏°</label><input id="accFarm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡∏ô‡∏ã‡∏±‡∏ô"></div>
          </div>
          <div class="flex" style="margin-top:10px">
            <button id="btnSaveAccount">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="right" id="btnLogout" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
          <div id="accMsg" class="small" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
      <div class="flex">
        <button id="btnOpenGuide">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</button>
        <span class="small">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤</span>
      </div>
    </div>

    <div class="card">
      <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏µ <span id="accYear"></span></h2>
      <div class="stat-grid">
        <div class="stat-box">
          <label>‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏∞‡∏™‡∏° (‡∏Å‡∏Å.)</label>
          <b id="statFertilizer">0</b>
        </div>
        <div class="stat-box">
          <label>‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏∞‡∏™‡∏° (‡∏•‡∏¥‡∏ï‡∏£)</label>
          <b id="statWater">0</b>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button id="btnAdjustStats">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</button>
        <span class="small">* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î ‚Äú‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Äù</span>
      </div>
    </div>
  </section>

  <nav class="bottom-nav">
    <button class="tab active" data-tab-target="home"><span class="emj">üè†</span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button class="tab" data-tab-target="chat"><span class="emj">ü§ñ</span>‡πÅ‡∏ä‡∏ó AI</button>
    <button class="tab" data-tab-target="location"><span class="emj">üìç</span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
    <button class="tab" data-tab-target="account"><span class="emj">üë§</span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
  </nav>

  <!-- Video Modal -->
  <div id="videoModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="video"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="‡∏õ‡∏¥‡∏î" data-close="video">√ó</button>
      <div class="ratio">
        <iframe id="videoFrame"
          src=""
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          referrerpolicy="origin-when-cross-origin"></iframe>
      </div>
      <div id="videoModalTitle" class="modal-title"></div>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="order"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="‡∏õ‡∏¥‡∏î" data-close="order">√ó</button>
      <h3 style="margin:0 0 8px">üßæ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ </h3>
      <div id="orderSummary" class="help"></div>
      <div class="flex" style="margin-top:10px">
        <button id="btnConfirmOrder">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button class="right" data-close="order">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- GUIDE MODAL -->
  <div id="guideModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="guide"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="‡∏õ‡∏¥‡∏î" data-close="guide">√ó</button>
      <h3 style="margin:0 0 8px">üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ</h3>
      <ul class="guide-list">
        <li><b>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</b> ‡∏Å‡∏î ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏®/‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</li>
        <li><b>‡∏î‡∏π‡πÅ‡∏•</b> ‡∏Å‡∏£‡∏¥‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ YouTube ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
        <li><b>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</b> ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á</li>
        <li><b>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏õ‡∏∏‡πã‡∏¢</b> ‡πÅ‡∏™‡∏î‡∏á‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥ 3 ‡πÉ‡∏ö </li>
        <li><b>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ </li>
        <li><b>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</b> ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li>
        <li><b>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</b> ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</li>
      </ul>
    </div>
  </div>

  <script>
/* ===================== Utilities ===================== */
function _closeAllModals(){
  document.querySelectorAll('.modal').forEach(m=>{
    m.classList.remove('show'); m.setAttribute('aria-hidden','true');
    const iframe = m.querySelector('iframe'); if(iframe) iframe.src='';
  });
}
window.addEventListener('keydown', (e)=>{
  if(e.key==='Escape') _closeAllModals();
});
document.addEventListener('click', (e)=>{
  const tgt = e.target.closest('[data-close]');
  if(tgt){
    const which = tgt.getAttribute('data-close');
    const el = document.getElementById(which+'Modal');
    if(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); const ifr=el.querySelector('iframe'); if(ifr) ifr.src=''; }
  }
});

/* ===================== MAP + GPS ===================== */
let map, baseLayer, clickColor='green';
const layerWork = L.layerGroup();
const layerDisease = L.layerGroup();

const LS_WORK = 'sf_map_work_v1';
const LS_DISEASE = 'sf_map_disease_v1';
const LS_FARM_HOME = 'sf_farm_home_v1';

let pendingDisease = null;
let accCircle = null;
let lastRawPos = null;
window._userMarker = null;
window._farmMarker = null;

function colorIcon(color){
  const html = `<div style="position:relative;width:20px;height:20px;background:${color};border-radius:50%;
    border:2px solid #fff;box-shadow:0 0 6px rgba(0,0,0,.4);"></div>`;
  return L.divIcon({className:'', html, iconSize:[20,20], iconAnchor:[10,10]});
}
function diseaseIcon(){
  const html = `<div style="position:relative;width:22px;height:22px;background:#a97cff;border-radius:50%;
    border:2px solid #fff;box-shadow:0 0 8px rgba(0,0,0,.5);"></div>`;
  return L.divIcon({className:'', html, iconSize:[22,22], iconAnchor:[11,11]});
}
function farmIcon(){
  const html = `<div style="position:relative;width:24px;height:24px;border-radius:50%;
    background:#4caf50;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">üè°</div>`;
  return L.divIcon({className:'', html, iconSize:[24,24], iconAnchor:[12,12]});
}
const ICONS = {
  green:  colorIcon('#39d353'),
  yellow: colorIcon('#ffd33d'),
  red:    colorIcon('#ff4d4f'),
  disease: diseaseIcon(),
  user: L.icon({
    iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize:[25,41],iconAnchor:[12,41],shadowSize:[41,41]
  }),
  farm: farmIcon()
};

function setCookie(name, value, days=365){
  const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&')+'=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}
function _readFarmHomeLS(){ try{ return JSON.parse(localStorage.getItem(LS_FARM_HOME)||'null'); }catch{ return null } }
function _writeFarmHomeLS(obj){ try{ localStorage.setItem(LS_FARM_HOME, JSON.stringify(obj)); }catch{} }
function readFarmHome(){
  let fh = _readFarmHomeLS();
  if (fh && typeof fh.lat==='number' && typeof fh.lng==='number') return fh;
  const c = getCookie(LS_FARM_HOME);
  if (c) {
    try {
      fh = JSON.parse(c);
      if (fh && typeof fh.lat==='number' && typeof fh.lng==='number'){
        _writeFarmHomeLS(fh);
        return fh;
      }
    }catch{}
  }
  return null;
}
function saveFarmHome(lat,lng){
  const obj = {lat, lng};
  _writeFarmHomeLS(obj);
  setCookie(LS_FARM_HOME, JSON.stringify(obj));
  renderFarmHome();
}
function clearFarmHome(){
  try{ localStorage.removeItem(LS_FARM_HOME); }catch{}
  setCookie(LS_FARM_HOME, "", -1);
  if(window._farmMarker){ layerWork.removeLayer(window._farmMarker); window._farmMarker=null; }
}
function renderFarmHome(){
  const fh = readFarmHome();
  if(!map || !fh) return;
  if(window._farmMarker){ layerWork.removeLayer(window._farmMarker); window._farmMarker=null; }
  window._farmMarker = L.marker([fh.lat, fh.lng], {icon:ICONS.farm})
    .bindPopup(`üè° <b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</b><br>${fh.lat.toFixed(6)}, ${fh.lng.toFixed(6)}<br><small>‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ ‚Äú‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï‚Äù</small>`)
    .addTo(layerWork);
}
function initMap(){
  baseLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: '&copy; Esri, Maxar, Earthstar Geographics, and the GIS User Community' }
  );
  const fh = readFarmHome();
  map = L.map('farmMap', {
    center: fh ? [fh.lat, fh.lng] : [13.736,100.523],
    zoom: fh ? 17 : 15,
    layers:[baseLayer, layerWork, layerDisease]
  });
  const legend = L.control({position:'topright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `
      <div><span class="dot" style="background:#39d353"></span> ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
      <div><span class="dot" style="background:#ffd33d"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏î</div>
      <div><span class="dot" style="background:#ff4d4f"></span> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏î</div>
      <hr style="border:none;border-top:1px solid #ddd;margin:6px 0">
      <div><span class="dot" style="background:#a97cff"></span> ‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ</div>
      <div><span class="dot" style="background:#4caf50"></span> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</div>`;
    return div;
  }; legend.addTo(map);

  map.on('click', (e)=>{
    if(pendingDisease){
      placeDiseaseMarker(e.latlng.lat, e.latlng.lng, pendingDisease.cls, pendingDisease.prob);
      pendingDisease = null; return;
    }
    placeWorkMarker(e.latlng.lat, e.latlng.lng, clickColor);
    saveWorkMarkers();
  });

  renderFarmHome();
  loadWorkMarkers();
  loadDiseaseMarkers();
}
function loc_setClickColor(c){
  clickColor = c;
  if(map){
    L.popup().setLatLng(map.getCenter()).setContent('‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏°‡∏∏‡∏î: '+(c==='green'?'‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß':c==='yellow'?'‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á':'‡πÅ‡∏î‡∏á')).openOn(map);
  }
}
function loc_clear(){
  const toRemove = [];
  layerWork.eachLayer(l=>{
    if(l !== window._userMarker && l !== accCircle && l !== window._farmMarker) toRemove.push(l);
  });
  toRemove.forEach(l=>layerWork.removeLayer(l));
  localStorage.removeItem(LS_WORK);
}
function readOffset(){ try{ return JSON.parse(localStorage.getItem('sf_gps_offset')||'null'); }catch{ return null } }
function saveOffset(dlat, dlng){ localStorage.setItem('sf_gps_offset', JSON.stringify({dlat, dlng})); }
function clearOffset(){ localStorage.removeItem('sf_gps_offset'); }
function getAccuratePosition({desired=25, timeout=15000}={}){
  return new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error('no geolocation'));
    let best=null; const start=Date.now();
    const id = navigator.geolocation.watchPosition(
      pos=>{
        best = (!best || pos.coords.accuracy < best.coords.accuracy) ? pos : best;
        if(pos.coords.accuracy <= desired){ navigator.geolocation.clearWatch(id); resolve(best); }
        else if(Date.now()-start>timeout){ navigator.geolocation.clearWatch(id); resolve(best||pos); }
      },
      err=>{ navigator.geolocation.clearWatch(id); reject(err); },
      { enableHighAccuracy:true, maximumAge:0, timeout }
    );
  });
}
const getCoarse = ({timeout=12000}={}) =>
  new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error('no geolocation'));
    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:false, maximumAge:60000, timeout });
  });
async function ipGeo(){
  const r = await fetch('https://ipapi.co/json/');
  if(!r.ok) throw new Error('ipapi fail');
  const j = await r.json();
  if(j.latitude==null || j.longitude==null) throw new Error('ipapi no lat/lng');
  return { lat:Number(j.latitude), lng:Number(j.longitude), acc:10000, source:'ipapi' };
}
async function googleGeo(apiKey){
  const r = await fetch(`https://www.googleapis.com/geolocation/v1/geolocate?key=${apiKey}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ considerIp: true })
  });
  if(!r.ok) throw new Error('google geo fail');
  const j = await r.json();
  return { lat:j.location.lat, lng:j.location.lng, acc:j.accuracy||100, source:'google' };
}
async function getSmartPosition({useGoogle=false, googleKey=''}={}){
  try{
    const p = await getAccuratePosition({desired:25, timeout:15000});
    return { lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy, source:'browser' };
  }catch{
    try{
      const p = await getCoarse({timeout:12000});
      return { lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy, source:'browser-coarse' };
    }catch{
      try{ return await ipGeo(); }
      catch{
        if(useGoogle && googleKey) return await googleGeo(googleKey);
        throw new Error('no position available');
      }
    }
  }
}
async function loc_readGPS(){
  try{
    const pos = await getSmartPosition();
    lastRawPos = { lat: pos.lat, lng: pos.lng, acc: pos.acc };

    const off = readOffset();
    const lat = lastRawPos.lat + (off?.dlat || 0);
    const lng = lastRawPos.lng + (off?.dlng || 0);

    if(!map) initMap();

    if(accCircle){ layerWork.removeLayer(accCircle); accCircle=null; }
    accCircle = L.circle([lat, lng], { radius: Math.max(lastRawPos.acc, 8), color:'#3388ff', fillOpacity:0.1 }).addTo(layerWork);

    if(window._userMarker){ layerWork.removeLayer(window._userMarker); }
    window._userMarker = L.marker([lat, lng], {icon:ICONS.user})
      .bindPopup(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô<br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><small>accuracy ~ ${Math.round(lastRawPos.acc)} m ‚Ä¢ source: ${pos.source}</small>`)
      .addTo(layerWork).openPopup();

    if(!readFarmHome()) saveFarmHome(lat, lng);

    map.setView([lat, lng], lastRawPos.acc > 8000 ? 13 : lastRawPos.acc > 80 ? 16 : 17);
  }catch(err){
    alert('‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message +
      '\n‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô http://localhost ‡∏´‡∏£‡∏∑‡∏≠ HTTPS\n‚Ä¢ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Location ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
  }
}
function loc_calibrate(){
  if(!map){ showPage('location'); initMap(); }
  if(!lastRawPos){ alert('‡∏Å‡∏î "‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö'); return; }
  const tip = L.popup().setLatLng(map.getCenter()).setContent('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á').openOn(map);
  const once = (e)=>{
    map.off('click', once); map.closePopup(tip);
    const t = e.latlng;
    saveOffset(t.lat-lastRawPos.lat, t.lng-lastRawPos.lng);
    saveFarmHome(t.lat, t.lng);

    if(window._userMarker){ layerWork.removeLayer(window._userMarker); }
    window._userMarker = L.marker([t.lat, t.lng], {icon:ICONS.user})
      .bindPopup(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)<br>${t.lat.toFixed(6)}, ${t.lng.toFixed(6)}`).addTo(layerWork).openPopup();
    if(accCircle){ layerWork.removeLayer(accCircle); }
    accCircle = L.circle([t.lat, t.lng], { radius: Math.max(lastRawPos.acc, 8), color:'#3388ff', fillOpacity:0.1 }).addTo(layerWork);

    map.setView([t.lat, t.lng], 18);
  };
  map.on('click', once);
}
function loc_clearCal(){
  clearOffset();
  clearFarmHome();
  alert('‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  loc_readGPS();
}
function loc_goFarm(){
  if(!map){ showPage('location'); initMap(); }
  const fh = readFarmHome();
  if(!fh){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°\n‡∏Å‡∏î "‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡πÅ‡∏•‡πâ‡∏ß "‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡πâ‡∏≤'); return; }
  map.setView([fh.lat, fh.lng], 18);
  if(window._farmMarker) window._farmMarker.openPopup();
}
function placeWorkMarker(lat,lng,color='green'){
  const mk = L.marker([lat,lng], {icon:ICONS[color]}).addTo(layerWork);
  mk.bindPopup(
    `<div>‡∏á‡∏≤‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥: <b>${color}</b><br>${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
     <button class="sf-del-btn" data-action="delWork" data-lat="${lat}" data-lng="${lng}">‡∏•‡∏ö</button>`
  );
}
function placeDiseaseMarker(lat,lng,cls,prob){
  const ts = new Date().toLocaleString();
  const mk = L.marker([lat,lng], {icon:ICONS.disease}).addTo(layerDisease);
  mk.bindPopup(
    `<div>‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ: <b>${cls}</b><br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${(prob*100).toFixed(1)}%<br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><i>${ts}</i></div>
     <button class="sf-del-btn" data-action="delDisease" data-lat="${lat}" data-lng="${lng}">‡∏•‡∏ö</button>`
  ).openPopup();
  saveDiseaseMarkers();
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button.sf-del-btn');
  if(!btn) return;
  const act = btn.getAttribute('data-action');
  const lat = Number(btn.getAttribute('data-lat'));
  const lng = Number(btn.getAttribute('data-lng'));
  if(act==='delWork'){
    layerWork.eachLayer(layer=>{
      const p = layer.getLatLng?.(); if(p && p.lat.toFixed(6)==lat.toFixed(6) && p.lng.toFixed(6)==lng.toFixed(6)){
        layerWork.removeLayer(layer); saveWorkMarkers();
      }
    });
  }else if(act==='delDisease'){
    layerDisease.eachLayer(layer=>{
      const p = layer.getLatLng?.(); if(p && p.lat.toFixed(6)==lat.toFixed(6) && p.lng.toFixed(6)==lng.toFixed(6)){
        layerDisease.removeLayer(layer); saveDiseaseMarkers();
      }
    });
  }
});
function saveWorkMarkers(){
  const arr = [];
  layerWork.eachLayer(layer=>{
    if(layer===window._userMarker || layer===accCircle || layer===window._farmMarker) return;
    const p = layer.getLatLng?.(); if(!p) return;
    const html = layer.options.icon?.options?.html || '';
    const color = html.includes('#ff4d4f') ? 'red' : html.includes('#ffd33d') ? 'yellow' : 'green';
    arr.push({lat:p.lat,lng:p.lng,color});
  });
  localStorage.setItem(LS_WORK, JSON.stringify(arr));
}
function loadWorkMarkers(){
  try{ (JSON.parse(localStorage.getItem(LS_WORK)||'[]')||[]).forEach(m=>placeWorkMarker(m.lat,m.lng,m.color)); }catch{}
}
function saveDiseaseMarkers(){
  const arr = [];
  layerDisease.eachLayer(layer=>{
    const p = layer.getLatLng?.(); if(!p) return;
    const meta = layer.getPopup()?.getContent() || '';
    const m = /‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ:\s*<b>(.*?)<\/b>.*?(\d+(?:\.\d+)?)%/s.exec(meta);
    arr.push({lat:p.lat,lng:p.lng,cls:m?m[1]:'Unknown',prob:m?Number(m[2])/100:0});
  });
  localStorage.setItem(LS_DISEASE, JSON.stringify(arr));
}
function loadDiseaseMarkers(){
  try{ (JSON.parse(localStorage.getItem(LS_DISEASE)||'[]')||[]).forEach(m=>placeDiseaseMarker(m.lat,m.lng,m.cls,m.prob)); }catch{}
}
async function diseaseToMap(cls, prob){
  try{
    const p = await getSmartPosition();
    if(!map){ showPage('location'); initMap(); }
    placeDiseaseMarker(p.lat, p.lng, cls, prob);
    map.setView([p.lat,p.lng], 18);
  }catch{
    pendingDisease = {cls, prob};
    showPage('location');
    if(!map) initMap();
    L.popup().setLatLng(map.getCenter()).setContent('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á ‚Äú‡∏à‡∏∏‡∏î‡∏û‡∏ö‡πÇ‡∏£‡∏Ñ‚Äù').openOn(map);
  }
}

/* ===================== CARE (YouTube) ===================== */
const CARE_VIDEOS = [
  'https://youtu.be/bxVVNDbcFlo?si=Rdp8HBUN1Ig1TOZ3',
  'https://youtu.be/nkSnxLHHO0M?si=GXQ8dv8ZeUd08ARV',
  'https://youtu.be/par799X6o1s?si=6RgPCb0ZpOYvEXsf',
  'https://youtu.be/C0ATvh2dtEE?si=Ham65qz8Kilx7Uqu',
  'https://youtu.be/S4QyMAaYqds?si=rN1htKIKMjK8dVjM',
  'https://youtu.be/8KqS4UtSho8?si=pyDeZOIxrBVcS8H5'
];
function ytIdFromUrl(url){
  try{
    const u = new URL(url);
    if(u.hostname === 'youtu.be') return u.pathname.slice(1);
    if(u.searchParams.get('v')) return u.searchParams.get('v');
    const m1 = u.pathname.match(/\/shorts\/([^/?#]+)/); if(m1) return m1[1];
    const m2 = u.pathname.match(/\/embed\/([^/?#]+)/);  if(m2) return m2[1];
    return null;
  }catch{ return null }
}
async function fetchYTTitle(url){
  try{
    const r = await fetch('https://www.youtube.com/oembed?format=json&url='+encodeURIComponent(url));
    if(!r.ok) throw new Error('oEmbed fail');
    const j = await r.json();
    return j.title || '';
  }catch{ return ''; }
}
function openVideo(id, title){
  const el = document.getElementById('videoModal');
  const iframe = document.getElementById('videoFrame');
  const ttl = document.getElementById('videoModalTitle');
  iframe.src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0`;
  ttl.textContent = title || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...';
  el.classList.add('show'); el.setAttribute('aria-hidden','false');
}
function closeVideo(){
  const el = document.getElementById('videoModal');
  const iframe = document.getElementById('videoFrame');
  el.classList.remove('show'); el.setAttribute('aria-hidden','true');
  iframe.src = '';
}
function renderCareVideos(){
  const grid = document.getElementById('videoGrid');
  if(!grid) return;
  grid.innerHTML = '';
  CARE_VIDEOS.forEach((url, i)=>{
    const id = ytIdFromUrl(url);
    if(!id) return;
    const thumb = `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
    const card = document.createElement('div');
    card.className = 'video-card';
    card.innerHTML = `
      <div class="thumb-wrap"><img alt="thumbnail" loading="lazy" src="${thumb}"></div>
      <div class="video-info">
        <div class="video-title" id="vt-${id}">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ...</div>
        <div class="video-meta">YouTube ¬∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>
      </div>`;
    card.addEventListener('click', ()=> openVideo(id, document.getElementById('vt-'+id)?.textContent || ''));
    grid.appendChild(card);
    fetchYTTitle(url)
      .then(t => { const el = document.getElementById('vt-'+id); if(el) el.textContent = t || `‡∏Ñ‡∏•‡∏¥‡∏õ #${i+1}`; })
      .catch(()=> { const el = document.getElementById('vt-'+id); if(el) el.textContent = `‡∏Ñ‡∏•‡∏¥‡∏õ #${i+1}`; });
  });
}

/* ===================== WORK simulation ===================== */
let simTimer=null;
function rand(min,max){ return Math.random()*(max-min)+min; }
function setLED(id,color){ const el=document.getElementById(id); if(el){ el.style.background=color; } }
function simTick(){
  for(let i=1;i<=3;i++){
    const dist = rand(5, 200);
    const ok = Math.random() > 0.05;
    setLED(`led_us${i}`, ok ? '#39d353' : '#ff4d4f');
    const tx = document.getElementById(`us${i}_txt`);
    if(tx) tx.innerHTML = ok ? `‡∏£‡∏∞‡∏¢‡∏∞‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ ~ <b>${dist.toFixed(1)}</b> ‡∏ã‡∏°.` : '‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‚ö†Ô∏è';
  }
  const hum = rand(40, 95);
  const humOk = hum>=50 && hum<=85;
  setLED('led_hum', humOk ? '#39d353' : '#ffd33d');
  const htxt = document.getElementById('hum_txt');
  if(htxt) htxt.innerHTML = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå ~ <b>${hum.toFixed(0)}%</b> ${humOk?'(‡∏õ‡∏Å‡∏ï‡∏¥)':'(‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)'}`;

  const rain = Math.random()<0.2 ? rand(0.2, 12) : 0;
  setLED('led_rain', rain>0 ? '#39d353' : '#9e9e9e');
  const rtxt = document.getElementById('rain_txt');
  if(rtxt) rtxt.innerHTML = rain>0 ? `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ù‡∏ô ~ <b>${rain.toFixed(1)} mm/h</b>` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ù‡∏ô';
}
function simStart(){ if(simTimer) return; simTimer = setInterval(simTick, 3000); simTick(); }
function simStop(){ if(simTimer){ clearInterval(simTimer); simTimer=null; } }

/* ===================== WATER (3 tanks) ===================== */
const LITER_TO_CM3 = 1000;
const TANK_CAP_L = 20;
const TANK_CAP_CM3 = TANK_CAP_L * LITER_TO_CM3;
function renderTanks(vals){
  const host = document.getElementById('tankGrid');
  host.innerHTML='';
  vals.forEach((cm3, idx)=>{
    const lit = cm3 / 1000;
    const pct = Math.max(0, Math.min(100, (cm3/TANK_CAP_CM3)*100));
    const warn = lit < 5;
    const div = document.createElement('div');
    div.className='tank';
    div.innerHTML = `
      <div><b>‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà ${idx+1}</b></div>
      <div class="bar" style="margin:8px 0 6px"><div style="width:${pct.toFixed(0)}%; background:${warn?'#ff4d4f':'#81c784'}"></div></div>
      <div>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${Math.round(cm3).toLocaleString()}</b> cm¬≥ (~${lit.toFixed(1)} ‡∏•‡∏¥‡∏ï‡∏£)</div>
      <div class="tip">${warn?'‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° (< 5 ‡∏•‡∏¥‡∏ï‡∏£)':'‡∏õ‡∏Å‡∏ï‡∏¥'}</div>
    `;
    host.appendChild(div);
  });
}
function randomTanks(){
  const arr = [0,0,0].map(()=> Math.round(Math.random()*TANK_CAP_CM3));
  renderTanks(arr);
}

/* ===================== FERTILIZER SHOP ===================== */
const FZ_IMAGE_URL = 'https://via.placeholder.com/800x600.png?text=%E0%B8%9B%E0%B8%B8%E0%B9%8B%E0%B8%A2';
const PRODUCTS = [
  { id:'f1', name:'‡∏õ‡∏∏‡πã‡∏¢ 16-16-8',  desc:'‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏ï‡πÉ‡∏ö-‡∏¢‡∏≠‡∏î ‡∏™‡∏°‡∏î‡∏∏‡∏• NPK', npk:'16-16-8',   price:380 },
  { id:'f2', name:'‡∏õ‡∏∏‡πã‡∏¢ ‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢',   desc:'‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô ‡πÄ‡∏£‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', npk:'46-0-0',   price:420 },
  { id:'f3', name:'‡∏õ‡∏∏‡πã‡∏¢ ‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', desc:'‡πÄ‡∏£‡πà‡∏á‡∏•‡∏á‡∏´‡∏±‡∏ß/‡∏´‡∏ß‡∏≤‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏ô‡πà‡∏ô', npk:'0-0-60',  price:450 },
];
let lastOrder=null;
function renderShop(){
  const host = document.getElementById('shopGrid');
  host.innerHTML='';
  PRODUCTS.forEach(p=>{
    const el = document.createElement('div');
    el.className='product';
    el.innerHTML = `
      <img class="p-img" src="${FZ_IMAGE_URL}" alt="${p.name}" />
      <div class="p-title">${p.name} ¬∑ NPK ${p.npk}</div>
      <div class="p-desc">${p.desc}</div>
      <div class="p-actions">
        <label class="small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ñ‡∏∏‡∏á)</label>
        <input type="number" data-qty="${p.id}" min="1" value="1" style="width:90px">
        <span class="right"><b>${p.price.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</span>
      </div>
      <div class="flex" style="margin-top:8px">
        <button data-order="${p.id}">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
      </div>
    `;
    host.appendChild(el);
  });
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-order]');
  if(!btn) return;
  const id = btn.getAttribute('data-order');
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const qtyInput = document.querySelector(`input[data-qty="${id}"]`);
  const q = Math.max(1, parseInt(qtyInput?.value||'1'));
  const sum = q * p.price;
  lastOrder = { product:p.name, npk:p.npk, unitPrice:p.price, qty:q, total:sum };
  const box = document.getElementById('orderSummary');
  box.innerHTML = `
    ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${p.name}</b> (NPK ${p.npk})<br>
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${q}</b> ‡∏ñ‡∏∏‡∏á √ó ${p.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó = <b>${sum.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó
  `;
  openOrder();
});
function openOrder(){
  const m = document.getElementById('orderModal');
  m.classList.add('show'); m.setAttribute('aria-hidden','false');
}
function closeOrder(){
  const m = document.getElementById('orderModal');
  m.classList.remove('show'); m.setAttribute('aria-hidden','true');
}
function confirmOrder(){
  alert('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');
  const yr = new Date().getFullYear().toString();
  const s = getYearStats(yr);
  const addKg = (lastOrder?.qty||0) * 1; // ‡∏ñ‡∏∏‡∏á‡∏•‡∏∞ ~1 ‡∏Å‡∏Å. 
  setYearStats(yr, { fertKg: (Number(s.fertKg)||0) + addKg, waterL: Number(s.waterL)||0 });
  updateAccountYearStatsUI();
  closeOrder();
}

/* ===================== REPORTS ===================== */
let fertChart, priceChart;
function makeMonthLabels(){
  const days = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
  return Array.from({length:days}, (_,i)=> (i+1).toString());
}
function cap10kg(arr){
  const sum = arr.reduce((a,b)=>a+b,0);
  if(sum<=10) return arr;
  const k = 10/sum;
  return arr.map(x=> +(x*k).toFixed(2));
}
function refreshReport(){
  const d = makeMonthLabels();
  let fert = d.map(()=> +(Math.random()*0.6).toFixed(2));
  fert = cap10kg(fert);
  const base = { banana:25, mango:40, durian:150 };
  const series = (b)=> d.map((_,i)=> +(b + Math.sin(i/3)*2 + (Math.random()*2-1)*1.5).toFixed(1));
  const banana = series(base.banana);
  const mango  = series(base.mango);
  const durian = series(base.durian);

  const ctx1 = document.getElementById('fertChart');
  if(fertChart) fertChart.destroy();
  fertChart = new Chart(ctx1, {
    type:'bar',
    data:{ labels:d, datasets:[{ label:'‡∏Å‡∏Å./‡∏ß‡∏±‡∏ô', data:fert }]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
  });
  const ctx2 = document.getElementById('priceChart');
  if(priceChart) priceChart.destroy();
  priceChart = new Chart(ctx2, {
    type:'line',
    data:{ labels:d, datasets:[
      { label:'‡∏Å‡∏•‡πâ‡∏ß‡∏¢', data:banana },
      { label:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', data:mango },
      { label:'‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', data:durian },
    ]},
    options:{ responsive:true, interaction:{mode:'index', intersect:false}, scales:{ y:{ beginAtZero:false } } }
  });
}

/* ===================== CHAT (offline) ===================== */
function demoChat(){
  const box = document.getElementById('chatBox');
  const q = document.getElementById('chatInput').value.trim();
  if(!q) return;
  const you = document.createElement('div'); you.innerHTML = `<b>‡∏Ñ‡∏∏‡∏ì:</b> ${q}`; box.appendChild(you);
  const bot = document.createElement('div');
  const reply = (q.includes('‡∏õ‡∏∏‡πã‡∏¢')||q.includes('fert')) ? '‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏ï‡∏£ 16-16-8 ‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ï‡∏Å‡πÉ‡∏ö‡∏à‡πâ‡∏≤' :
                (q.includes('‡∏ô‡πâ‡∏≥') ? '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏ä‡∏∏‡πà‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏â‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ô‡∏∞' :
                 '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö ‡πÜ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
  bot.innerHTML = `<b>‡∏ö‡∏≠‡∏ó:</b> ${reply}`;
  box.appendChild(bot);
  document.getElementById('chatInput').value='';
}

/* ===================== ACCOUNT persist ===================== */
const LS_ACC_NAME   = 'acc_owner';
const LS_ACC_FARM   = 'acc_farm';
const LS_ACC_AVATAR = 'acc_avatar_dataurl';
const LS_STATS      = 'acc_stats_by_year_v1';

function readStatsAll(){
  try{ return JSON.parse(localStorage.getItem(LS_STATS)||'{}'); }catch{ return {} }
}
function writeStatsAll(obj){
  localStorage.setItem(LS_STATS, JSON.stringify(obj||{}));
}
function getYearStats(year){
  const all = readStatsAll();
  return all[year] || { fertKg: 0, waterL: 0 };
}
function setYearStats(year, stats){
  const all = readStatsAll();
  all[year] = { fertKg: Number(stats.fertKg||0), waterL: Number(stats.waterL||0) };
  writeStatsAll(all);
}
function loadAccountUI(){
  const owner = localStorage.getItem(LS_ACC_NAME)||'';
  const farm  = localStorage.getItem(LS_ACC_FARM)||'';
  const av    = localStorage.getItem(LS_ACC_AVATAR)||'';
  document.getElementById('accOwner').value = owner;
  document.getElementById('accFarm').value  = farm;
  const $img = document.getElementById('accAvatarPreview');
  $img.src = av || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="110" height="110"><rect width="100%" height="100%" fill="%23cfe9cf"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="%231b5e20" font-family="Segoe UI, Arial" font-size="14">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</text></svg>`);
}
function saveAccount(){
  const owner = document.getElementById('accOwner')?.value.trim() || '';
  const farm  = document.getElementById('accFarm')?.value.trim() || '';
  localStorage.setItem(LS_ACC_NAME, owner);
  localStorage.setItem(LS_ACC_FARM, farm);
  const msg = document.getElementById('accMsg');
  msg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
  setTimeout(()=>msg.textContent='', 2000);
}
function handleAvatarFile(e){
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const dataUrl = reader.result;
    localStorage.setItem(LS_ACC_AVATAR, dataUrl);
    document.getElementById('accAvatarPreview').src = dataUrl;
  };
  reader.readAsDataURL(f);
}
function updateAccountYearStatsUI(){
  const yr = new Date().getFullYear().toString();
  const s = getYearStats(yr);
  document.getElementById('accYear').textContent = yr;
  document.getElementById('statFertilizer').textContent = (Number(s.fertKg)||0).toFixed(2);
  document.getElementById('statWater').textContent = (Number(s.waterL)||0).toFixed(0);
}
function adjustStatsPrompt(){
  const yr = new Date().getFullYear().toString();
  const s = getYearStats(yr);
  const fert = prompt(`‡∏õ‡πâ‡∏≠‡∏ô "‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏∞‡∏™‡∏° (‡∏Å‡∏Å.)" ‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${yr}`, s.fertKg ?? 0);
  if(fert===null) return;
  const water = prompt(`‡∏õ‡πâ‡∏≠‡∏ô "‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏∞‡∏™‡∏° (‡∏•‡∏¥‡∏ï‡∏£)" ‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${yr}`, s.waterL ?? 0);
  if(water===null) return;
  setYearStats(yr, { fertKg: Number(fert)||0, waterL: Number(water)||0 });
  updateAccountYearStatsUI();
  const msg = document.getElementById('accMsg');
  msg.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
  setTimeout(()=>msg.textContent='', 2000);
}
function logoutAccount(){
  localStorage.removeItem(LS_ACC_NAME);
  localStorage.removeItem(LS_ACC_FARM);
  localStorage.removeItem(LS_ACC_AVATAR);
  localStorage.removeItem(LS_STATS);
  loadAccountUI();
  updateAccountYearStatsUI();
  const msg = document.getElementById('accMsg');
  msg.textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥)';
  setTimeout(()=>msg.textContent='', 2500);
}

/* ===================== HOME demo ===================== */
function demoFillHome(){
  const loc = document.getElementById('locInput').value.trim() || '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ¬∑ ‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á';
  localStorage.setItem('sf_loc', loc);
  const w = { temp: 31, humid: 72, cond:'‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', rain: 35 };
  document.getElementById('weatherBox').innerHTML =
    `<div><b>${loc}</b></div>
     <div>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ${w.temp}¬∞C ¬∑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ${w.humid}%</div>
     <div>‡∏™‡∏†‡∏≤‡∏û: ${w.cond} ¬∑ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô ${w.rain}%</div>
     <div class="help">TODO: ‡∏ï‡πà‡∏≠ API ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á</div>`;
  const prices = [
    {name:'‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°', unit:'‡∏Å‡∏Å.', price:27},
    {name:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ', unit:'‡∏Å‡∏Å.', price:45},
    {name:'‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á', unit:'‡∏Å‡∏Å.', price:155},
  ];
  document.getElementById('priceBox').innerHTML =
    prices.map(p=>`‚Ä¢ ${p.name} ~ <b>${p.price}</b> ‡∏ö‡∏≤‡∏ó/${p.unit}`).join('<br>')+
    `<div class="help">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</div>`;
}

/* ===================== Router & bindings ===================== */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-tab-target')===id));
  localStorage.setItem('sf_last', id);
  if(id==='location' && !map){ initMap(); }
}
function bindNav(){
  document.querySelectorAll('.menu-item[data-nav]').forEach(el=>{
    el.addEventListener('click', ()=> showPage(el.getAttribute('data-nav')));
  });
  document.querySelectorAll('.tab[data-tab-target]').forEach(btn=>{
    btn.addEventListener('click', ()=> showPage(btn.getAttribute('data-tab-target')));
  });
}

/* ===================== INIT ===================== */
(function init(){
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï modal ‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å
  _closeAllModals();

  // Theme & last page
  const last = localStorage.getItem('sf_last'); if(last && document.getElementById(last)) showPage(last);
  const theme = localStorage.getItem('sf_theme') || 'light'; document.documentElement.dataset.theme = theme;

  // Bind nav
  bindNav();

  // Home
  document.getElementById('locInput').value = localStorage.getItem('sf_loc')||'';
  document.getElementById('btnFetch')?.addEventListener('click', demoFillHome);
  document.getElementById('btnTheme')?.addEventListener('click', ()=>{
    const cur = document.documentElement.dataset.theme==='dark'?'light':'dark';
    document.documentElement.dataset.theme = cur;
    localStorage.setItem('sf_theme', cur);
  });
  demoFillHome();

  // Care
  renderCareVideos();

  // Work
  document.getElementById('btnSimStart')?.addEventListener('click', simStart);
  document.getElementById('btnSimStop')?.addEventListener('click', simStop);
  simStart();

  // Water
  document.getElementById('btnWaterRand')?.addEventListener('click', randomTanks);
  randomTanks();

  // Fertilizer
  renderShop();
  document.getElementById('btnConfirmOrder')?.addEventListener('click', confirmOrder);

  // Report
  refreshReport();
  document.getElementById('btnReportRefresh')?.addEventListener('click', refreshReport);

  // Location buttons
  document.getElementById('btnReadGPS')?.addEventListener('click', loc_readGPS);
  document.getElementById('btnCalibrate')?.addEventListener('click', loc_calibrate);
  document.getElementById('btnClearCal')?.addEventListener('click', loc_clearCal);
  document.getElementById('btnGoFarm')?.addEventListener('click', loc_goFarm);
  document.getElementById('btnPinGreen')?.addEventListener('click', ()=>loc_setClickColor('green'));
  document.getElementById('btnPinYellow')?.addEventListener('click', ()=>loc_setClickColor('yellow'));
  document.getElementById('btnPinRed')?.addEventListener('click', ()=>loc_setClickColor('red'));
  document.getElementById('btnClearPins')?.addEventListener('click', loc_clear);

  // Chat
  document.getElementById('btnChatSend')?.addEventListener('click', demoChat);

  // Disease page
  document.getElementById('diseaseFile')?.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    document.getElementById('diseasePreview').innerHTML =
      `<img src="${url}" style="max-width:100%; border-radius:12px">`;
  });
  document.getElementById('btnDiseaseDemo')?.addEventListener('click', ()=>{
    const txt = "‡πÄ‡∏î‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πÇ‡∏°‡πà: ‡πÉ‡∏ö‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏®‡∏©‡πÉ‡∏ö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏û‡πà‡∏ô‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£";
    document.getElementById('diseaseResult').value = txt;
    document.getElementById('top3Box').innerHTML = "‚Ä¢ A1 ‚Äî 76.2%<br>‚Ä¢ Healthy ‚Äî 18.9%<br>‚Ä¢ A2 ‚Äî 4.9%";
  });
  document.getElementById('btnMarkDisease')?.addEventListener('click', ()=>{
    diseaseToMap('‡πÅ‡∏≠‡∏ô‡πÅ‡∏ó‡∏£‡∏Ñ‡πÇ‡∏ô‡∏™ (‡πÄ‡∏î‡πÇ‡∏°‡πà)', 0.76);
  });

  // Video modal close (dup safe)
  document.querySelectorAll('[data-close="video"]').forEach(x=>x.addEventListener('click', closeVideo));

  // Account
  loadAccountUI();
  updateAccountYearStatsUI();
  document.getElementById('accAvatarFile')?.addEventListener('change', handleAvatarFile);
  document.getElementById('btnSaveAccount')?.addEventListener('click', saveAccount);
  document.getElementById('btnAdjustStats')?.addEventListener('click', adjustStatsPrompt);
  document.getElementById('btnLogout')?.addEventListener('click', logoutAccount);
  document.getElementById('btnOpenGuide')?.addEventListener('click', ()=>{
    const m = document.getElementById('guideModal');
    m.classList.add('show'); m.setAttribute('aria-hidden','false');
  });
})();
  </script>
</body>
</html>
